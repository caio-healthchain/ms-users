generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Modelo de Usuário
model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Informações básicas
  name      String
  email     String   @unique
  cpf       String?  @unique
  phone     String?
  avatar    String?

  // Azure AD Integration
  azureAdId       String?  @unique @map("azure_ad_id")
  azureAdTenantId String? @map("azure_ad_tenant_id")
  
  // Status
  isActive Boolean @default(true) @map("is_active")
  
  // Relacionamentos
  userHospitalProfiles UserHospitalProfile[]
  auditLogs            AuditLog[]

  @@index([email])
  @@index([azureAdId])
  @@index([isActive])
  @@map("users")
}

// Perfis disponíveis no sistema
model Profile {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Informações do perfil
  code        String   @unique // GERENCIAL, AUDITOR, ANALISTA
  name        String   // Nome amigável
  description String?
  
  // Módulos permitidos (JSON array)
  allowedModules Json @map("allowed_modules") // ["gerencial", "auditor", "analista"]
  
  // Permissões (JSON)
  permissions Json
  
  // Status
  isActive Boolean @default(true) @map("is_active")

  // Relacionamentos
  userHospitalProfiles UserHospitalProfile[]

  @@index([code])
  @@index([isActive])
  @@map("profiles")
}

// Hospital (informações básicas - detalhes no ms-hospital-integration)
model Hospital {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Identificação
  code        String   @unique // h9j, hsl, etc
  name        String
  cnpj        String?  @unique
  
  // Configuração de tenant
  subdomain   String   @unique // h9j-lazarus
  customDomain String? @unique @map("custom_domain") // lazarus.h9j.com.br
  
  // Azure AD Tenant (cada hospital pode ter seu próprio tenant)
  azureTenantId String? @map("azure_tenant_id")
  
  // Logo e branding
  logoUrl     String? @map("logo_url")
  primaryColor String? @map("primary_color") // #1E40AF
  
  // Status
  isActive Boolean @default(true) @map("is_active")
  
  // Relacionamentos
  userHospitalProfiles UserHospitalProfile[]

  @@index([code])
  @@index([subdomain])
  @@index([isActive])
  @@map("hospitals")
}

// Relacionamento N:N entre User, Hospital e Profile
model UserHospitalProfile {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relacionamentos
  userId     String @map("user_id")
  hospitalId String @map("hospital_id")
  profileId  String @map("profile_id")
  
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  hospital Hospital @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  profile  Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  // Status
  isActive Boolean @default(true) @map("is_active")
  
  // Metadados
  grantedBy   String? @map("granted_by") // ID do usuário que concedeu o acesso
  grantedAt   DateTime @default(now()) @map("granted_at")
  revokedBy   String? @map("revoked_by")
  revokedAt   DateTime? @map("revoked_at")

  @@unique([userId, hospitalId, profileId])
  @@index([userId])
  @@index([hospitalId])
  @@index([profileId])
  @@index([isActive])
  @@map("user_hospital_profiles")
}

// Log de auditoria de ações de usuários
model AuditLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")

  // Usuário
  userId   String @map("user_id")
  userName String @map("user_name")
  userEmail String @map("user_email")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Ação
  action      String // LOGIN, LOGOUT, ACCESS_HOSPITAL, CHANGE_PROFILE, etc
  description String
  
  // Contexto
  hospitalId String? @map("hospital_id")
  profileId  String? @map("profile_id")
  
  // Dados técnicos
  ipAddress String @map("ip_address")
  userAgent String @map("user_agent")
  
  // Metadados
  metadata Json?

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([hospitalId])
  @@map("auth_audit_logs")
}

// Sessões de usuário (para controle de acesso multi-tenant)
model UserSession {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Usuário
  userId String @map("user_id")
  
  // Hospital selecionado
  hospitalId String @map("hospital_id")
  
  // Token
  accessToken  String   @unique @map("access_token")
  refreshToken String?  @unique @map("refresh_token")
  expiresAt    DateTime @map("expires_at")
  
  // Dados técnicos
  ipAddress String @map("ip_address")
  userAgent String @map("user_agent")
  
  // Status
  isActive Boolean @default(true) @map("is_active")
  
  @@index([userId])
  @@index([hospitalId])
  @@index([accessToken])
  @@index([isActive])
  @@index([expiresAt])
  @@map("user_sessions")
}
